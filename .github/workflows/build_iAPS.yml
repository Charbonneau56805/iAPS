name: 4. Build iAPS
run-name: Build iAPS (${{ github.ref_name }})

on:
  workflow_dispatch:
  push:

env:
  UPSTREAM_REPO: Artificial-Pancreas/iAPS
  UPSTREAM_BRANCH: ${{ github.ref_name }}
  TARGET_BRANCH: ${{ github.ref_name }}

jobs:
  auto_build_check:
    name: Check Auto Build Status
    runs-on: ubuntu-latest
    outputs:
      AUTO_BUILD_ENABLED: ${{ steps.auto-build-enabled.outputs.auto_build }}

    steps:
      - name: Is Auto Build Branch
        id: auto-build-enabled
        run: |
          echo "auto_build=false" >> $GITHUB_OUTPUT
          if [ ! -z "${{ vars.AUTO_BUILD_BRANCHES }}" ]; then
            if echo ",${{ vars.AUTO_BUILD_BRANCHES }}," | grep -q ",${{ github.ref_name }},"; then
              echo "auto_build=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Show Auto Build Status
        run: echo "Auto Build Enabled = ${{ steps.auto-build-enabled.outputs.auto_build }}"

  check_certs:
    needs: auto_build_check
    name: Check certificates
    if: needs.auto_build_check.outputs.AUTO_BUILD_ENABLED == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/create_certs.yml
    secrets: inherit

  check_latest_from_upstream:
    needs: [check_certs]
    runs-on: ubuntu-latest
    name: Check upstream
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

  build:
    name: Build
    needs: [check_certs, check_latest_from_upstream]
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Set optional variables
        run: |
          if [ -n "${{ vars.APP_IDENTIFIER }}" ]; then
            echo "APP_IDENTIFIER=${{ vars.APP_IDENTIFIER }}" >> $GITHUB_ENV
          fi
          if [ -n "${{ vars.BUILD_GROUP }}" ]; then
            echo "BUILD_GROUP=${{ vars.BUILD_GROUP }}" >> $GITHUB_ENV
          fi

      # âœ… Use the default Xcode with iPhoneOS SDK installed
      - name: Select Xcode
        run: sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

      # ðŸ” Debug visibility (helps immediately if something changes on runners)
      - name: Show installed Xcodes
        run: ls -1 /Applications | grep -i xcode

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Checkout repo for build
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          submodules: recursive
          ref: ${{ env.TARGET_BRANCH }}

      - name: Install Bundler 2.x
        run: |
          gem install bundler -v 2.7.2
          echo "BUNDLER_VER=2.7.2" >> $GITHUB_ENV

      - name: Patch Match table output
        run: |
          find /usr/local/lib/ruby/gems -name table_printer.rb | \
          xargs sed -i "" "/puts(Terminal::Table.new(params))/d"

      - name: Install Ruby dependencies
        run: bundle _${{ env.BUNDLER_VER }}_ install

      - name: Sync clock
        run: sudo sntp -sS time.windows.com

      # -------------------------------
      # Code signing setup
      # -------------------------------
      - name: Create temp keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security list-keychains -d user -s build.keychain

      - name: Import signing certificate
        run: |
          echo "${{ secrets.CERT_P12_BASE64 }}" | base64 --decode > cert.p12
          security import cert.p12 \
            -k build.keychain \
            -P "${{ secrets.CERT_P12_PASSWORD }}" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.CERT_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Verify signing identities
        run: security find-identity -v -p codesigning build.keychain

      # -------------------------------
      # Build
      # -------------------------------
      - name: Fastlane Build & Archive
        run: bundle _${{ env.BUNDLER_VER }}_ exec fastlane build_iAPS
        env:
          TEAMID: ${{ secrets.TEAMID }}
          GH_PAT: ${{ secrets.GH_PAT }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Upload to TestFlight
        run: bundle _${{ env.BUNDLER_VER }}_ exec fastlane release
        env:
          TEAMID: ${{ secrets.TEAMID }}
          GH_PAT: ${{ secrets.GH_PAT }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            artifacts
            buildlog
